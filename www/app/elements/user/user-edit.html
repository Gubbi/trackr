<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="user-edit">
  <style>
    paper-card {
      width: 300px;
      max-width: 90vw;
      border-top: 2px solid #9C27B0;
      background-color: white;
    }

    paper-input[readonly]  {
      /* line color when the input is unfocused */
      --paper-input-container-underline: {
        display:none;
      }
      --paper-input-container-underline-focus: {
        display:none;
      }
      --paper-input-container-underline-disabled: {
        display:none;
      }
    }

    .card-actions, .card-actions a {
      color: rgba(0,0,0,.15);
    }

    .card-actions:hover, .card-actions:hover a {
      color: rgba(0,0,0,.6);
    }

    paper-toast {
        width: 100%;
        min-width: 0;
        border-radius: 0;
        margin: 0;
        text-align: center;
        font-size: 1.05em;
    }

    paper-toast.error {
        background-color: #D50000;
        color: rgba(255, 255, 255, 0.87);
    }

    paper-toast.success {
        background-color: #33691E;
        color: rgba(255, 255, 255, 0.87);
    }

    .label {
      padding: 8px 0 4px;
      font-size: 0.75em;
      color: #727272;
    }

    paper-checkbox {
      padding: 8px 0 4px;
    }
  </style>
  <template>
    <paper-card>
      <div>
        <div class="card-content">
          <paper-input name="name" label="Name" value="{{user.name}}" required></paper-input>
          <paper-input name="email" label="Email" value="{{user.email}}" required readonly$={{!isNew}}></paper-input>
          <paper-input name="phone" label="Mobile No" value="{{user.phone}}" required></paper-input>
          <br/>
          <div class="label">Permissions</div>
          <div><paper-checkbox checked="{{isAdmin}}"> Admin</paper-checkbox></div>
          <div><paper-checkbox checked="{{isOps}}"> Ops</paper-checkbox></div>
        </div>
        <div class="card-actions horizontal layout center flex">
          <paper-icon-button icon="close" title="Cancel" on-tap="cancel"></paper-icon-button>
          <paper-icon-button icon="delete" title="Delete" on-tap="delete"></paper-icon-button>
          <span class="flex"></span>
          <paper-spinner alt="Saving Changes" active="[[isSaving]]"></paper-spinner>
          <paper-icon-button icon="done" title="Save" on-tap="save"></paper-icon-button>
        </div>
      </div>
    </paper-card>

    <paper-toast class="error" id="errorMsg" text="{{errorMessage}}" duration="0"></paper-toast>
    <paper-toast class="success" id="successMsg" text="[[successMessage]]"></paper-toast>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'user-edit',

        properties: {
          user: {
            type: Object,
            observer: '_ValChanged'
          },
          isAdmin: {
            type: Boolean,
            value: false
          },
          isOps: {
            type: Boolean,
            value: true
          },
          isNew: {
            type: Boolean,
            value: true
          }
        },

        ready: function() {
          var _this = this;
          onAuthReady(function() {
            _this._ValChanged.call(_this);
          });
        },

        _ValChanged: function() {
          if(!this.user) {
            return;
          }

          this.isAdmin = this.user.roles.indexOf('Admin') > -1;
          this.isOps = this.user.roles.indexOf('Ops') > -1;
        },

        save: function() {
          var _this = this;

          if (!this.user.phone) {
            this.show_error('Phone number is required.');
            return;
          }

          if (!this.user.email) {
            this.show_error('Email ID is required.');
            return;
          }

          if (!this.user.name) {
            this.show_error('Name is required.');
            return;
          }

          roles = [];
          if(this.isAdmin) {
            roles.push('Admin');
          }
          if(this.isOps) {
            roles.push('Ops');
          }
          this.user.roles = roles;

          this.isSaving = true;
          superagent.post('/bkend/accounts/add')
                  .send(this.user)
                  .end(function(err, res) {
                    _this.isSaving = false;
                    if (res.ok) {
                      _this.show_success(res.body.message);
                      _this.fire('updated');
                    } else {
                      _this.show_error(res.body.message);
                    }
                  });
        },

        delete: function() {
          var _this = this;

          this.isSaving = true;
          superagent.post('/bkend/accounts/remove')
                    .send({'email': this.user.email})
                    .end(function(err, res) {
                      _this.isSaving = false;
                      if (res.ok) {
                        _this.show_success(res.body.message);
                        _this.fire('updated');
                      } else {
                        _this.show_error(res.body.message);
                      }
                    });
        },

        cancel: function() {
          this.$.errorMsg.close();
          this.fire('cancelled');
        },

        show_success: function(message) {
            this.successMessage = message;
            this.$.successMsg.show();
        },

        show_error: function(message) {
            this.errorMessage = message;
            this.$.errorMsg.open();
        }
      });
    })();
  </script>
</dom-module>
