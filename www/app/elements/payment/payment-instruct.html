<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="payment-instruct">
  <style>
    :host paper-card {
      width: 400px;
      /*max-width: 90vw;*/
      margin: 30px auto;
      border-top: 2px solid #8BC34A;
      background-color: #FFFFFF;
    }

    paper-input[readonly], paper-textarea[readonly] {
      /* line color when the input is unfocused */
      --paper-input-container-underline: {
        display:none;
      }
      --paper-input-container-underline-focus: {
        display:none;
      }
      --paper-input-container-underline-disabled: {
        display:none;
      }
    }

    paper-material {
      padding: 20px;
      margin: 10px 0;
    }

    .min-text {
      font-size: 0.8em;
      opacity: 0.5;
      margin-bottom: 6px;
    }

    .text-warning {
      background-color: #fcf8e3;
    }

    .summary>div {
      margin-bottom: 28px;
    }

    .float-left{
      float: left;
    }

    .align-right {
      text-align: right;
    }

    paper-toast {
      width: 100%;
      min-width: 0;
      border-radius: 0;
      margin: 0;
      text-align: center;
      font-size: 1.05em;
    }

    paper-toast.error {
      background-color: #D50000;
      color: rgba(255, 255, 255, 0.87);
    }

    paper-toast.success {
      background-color: #33691E;
      color: rgba(255, 255, 255, 0.87);
    }
  </style>
  <template>
    <div class="card-actions horizontal layout center flex">
      <span class="flex"></span>
      <iron-pages attr-for-selected="sub-route" selected="{{show}}">
        <paper-card sub-route="search">
          <div>
            <div class="card-content">
              <paper-input name="phone" id="provider_phone" label="Payer Mobile No" value="{{provider.phone}}" allowed-pattern="[0-9]" char-counter maxlength="10" required always-float-label>
              </paper-input>
            </div>
            <div class="card-actions horizontal layout center">
              <span class="flex"></span>
              <paper-spinner alt="Searching..." active="[[isSearching]]"></paper-spinner>
              <paper-icon-button icon="done" title="Next" on-tap="search"></paper-icon-button>
            </div>
          </div>
        </paper-card>

        <paper-card sub-route="contact" heading="Payer Details">
          <div>
            <div class="card-content">
              <paper-input name="name" id="provider_name" label="Name *" value="{{provider.name}}" required></paper-input>
              <paper-textarea name="contact" id="provider_contact" label="Address" value="{{provider.contact}}"></paper-textarea>
              <paper-input name="pincode" id="provider_pincode" label="Pin code *" value="{{provider.pincode}}" maxlength="6" required></paper-input>
              <paper-input name="phone" id="provider_phone2" label="Mobile No" value="{{provider.phone}}" required readonly></paper-input>
            </div>
            <div class="card-actions horizontal layout center">
              <paper-icon-button icon="arrow-back" title="Provider Mobile" alt="Back" on-tap="goto" data-goto="search"></paper-icon-button>
              <paper-icon-button icon="close" title="Cancel" alt="Cancel" on-tap="home"></paper-icon-button>
              <span class="flex"></span>
              <paper-spinner alt="Saving Details" active="[[isSaving]]"></paper-spinner>
              <paper-icon-button icon="done" title="Next" on-tap="save"></paper-icon-button>
            </div>
          </div>
        </paper-card>

        <paper-card sub-route="jobs" heading="Orders/Jobs">
          <div>
            <div class="card-content">
              <paper-textarea name="job_data" rows="10" id="provider_job_data" label="Paste Order/Job ID, Amount here" value="{{provider.job_data}}" required></paper-textarea>
            </div>
            <div class="card-actions horizontal layout center">
              <paper-icon-button icon="arrow-back" title="Provider Details" alt="Back" on-tap="goto" data-goto="contact"></paper-icon-button>
              <paper-icon-button icon="close" title="Cancel" alt="Cancel" on-tap="home"></paper-icon-button>
              <span class="flex"></span>
              <paper-spinner active="[[isRequesting]]"></paper-spinner>
              <paper-icon-button icon="done" title="Next" on-tap="verify"></paper-icon-button>
            </div>
          </div>
        </paper-card>

        <paper-card sub-route="jobs_verified" heading="Order/Job details">
          <div>
            <div class="summary card-content">
              <paper-input name="name" id="total_amount" label="Total Amount" value="{{total}}" readonly></paper-input>
              <paper-input name="name" id="NumJobs" label="Number of Orders/Jobs" value="{{jobs.count}}" readonly></paper-input>
              <paper-textarea name="name" id="RepeatJobs" label="Repeated IDs" value="{{jobs.repeat_jobs}}" readonly hidden="{{hasNoJobsRepeated}}"></paper-textarea>
            </div>
            <div class="card-actions horizontal layout center">
              <paper-icon-button icon="arrow-back" title="Edit Jobs" alt="Back" on-tap="goto" data-goto="jobs"></paper-icon-button>
              <paper-icon-button icon="close" title="Cancel" alt="Cancel" on-tap="home"></paper-icon-button>
              <span class="flex"></span>
              <paper-spinner active="[[isRequesting]]"></paper-spinner>
              <paper-button class="actions" title="Generates KyashCode" on-tap="kyashcode" active="[[isEnabled]]">Confirm</paper-button>
            </div>
          </div>
        </paper-card>

        <paper-card sub-route="result">
          <div>
            <div class="card-content">
              <p>Payment instructions have been sent to the payer.</p>
              <paper-input name="name" id="kyash_code" label="KyashCode" value="{{kyash_code}}" readonly></paper-input>
            </div>
            <div class="card-actions horizontal layout center">
              <span class="flex"></span>
              <paper-button class="actions" title="Home" on-tap="home" active="[[isEnabled]]">OK</paper-button>
              <paper-icon-button class="actions" title="Payment Points" alt="Points" icon="store" on-tap="showPoints"></paper-icon-button>
            </div>
          </div>
        </paper-card>
      </iron-pages>
      <span class="flex"></span>
    </div>

    <paper-toast class="error" id="errorMsg" text="{{errorMessage}}" duration="0"></paper-toast>
    <paper-toast class="success" id="successMsg" text="[[successMessage]]"></paper-toast>
  </template>

  <script>
    (function() {
      Polymer({
        is: 'payment-instruct',

        properties: {
          show: {
            type: String,
            value: 'search'
          },

          provider: {
            type: Object,
            value: {}
          },

          jobs: {
            type: Object,
            value: {}
          },

          kyash_code: String,

          total: String,

          isDisabled: {
            type: Boolean,
            value: true
          },

          hasNoJobsRepeated: {
            type: Boolean,
            value: true
          }
        },

        listeners: {
          'inview': 'inview'
        },

        inview: function() {
          app.disableSearch();
        },

        ready: function() {
        },

        goto: function(e) {
          this.show = Polymer.dom(e).path[2].getAttribute('data-goto');
        },

        home: function () {
          this.provider = {};
          this.jobs = {};
          this.kyash_code = '';
          this.total = '';

          this.show = 'search';
        },

        search: function() {
          var _this = this;
          if (!this.provider.phone) {
            this.show_error('Phone number is required.');
            return;
          }
          this.isSearching = true;
          superagent.get('/bkend/search_provider?phone=' + this.provider.phone)
            .end(function(err, res) {
              _this.isSearching = false;
              if (res.ok) {
                var result = JSON.parse(res.text);
                if(result.provider) {
                  _this.provider = result.provider;
                }
                _this.show_success(res.body.message);
                _this.show = 'contact';
              } else {
                _this.show_error(res.body.message);
              }
            });
        },

        save: function() {
          var _this = this;
          if (!_this.provider.name || !_this.provider.phone || !_this.provider.pincode) {
            this.show_error('Name, Phone and Pin code are required.');
            return;
          }
          this.isSaving = true;
          superagent.post('/bkend/search_provider')
            .send(this.provider)
            .end(function(err, res) {
              _this.isSaving = false;
              if (res.ok) {
                var result = JSON.parse(res.text);
                _this.provider = result.provider;
                _this.show = 'jobs';
                _this.show_success(res.body.message);
              } else {
                _this.show_error(res.body.message);
              }
            });
        },

        verify: function() {
          var _this = this;
          if (!_this.provider.job_data) {
            this.show_error('Job ids and amount are required.');
            return;
          }
          this.isRequesting = true;
          superagent.post('/bkend/verify_jobs')
            .send(this.provider)
            .end(function(err, res) {
              _this.isRequesting = false;
              if (res.ok) {
                var result = JSON.parse(res.text);
                if(result.job_details) {
                  _this.jobs = result.job_details;
                  _this.total = 'â‚¹' + result.total;
                }
                _this.show = 'jobs_verified';
                _this.show_success(res.body.message);
                _this.isDisabled=false;
                _this.hasNoJobsRepeated = !Boolean(_this.jobs.repeat_jobs.length);
              } else {
                _this.show_error(res.body.message);
              }
            });
        },

        kyashcode: function() {
          var _this = this;
          if (!_this.provider.job_data) {
            this.show_error('Job ids and amount are required.');
            return;
          }
          this.isRequesting = true;
          superagent.post('/bkend/payment/create')
            .send(this.provider)
            .end(function(err, res) {
              _this.isRequesting = false;
              if (res.ok) {
                var result = JSON.parse(res.text);
                if(result.kyash_code){
                  _this.kyash_code = result.kyash_code;
                }
                _this.show = 'result';
                _this.show_success(res.body.message);
              } else {
                _this.show_error(res.body.message);
              }
            });
        },

        showPoints: function() {
          var el = document.createElement('kyash-points');
          console.log(el);
          el.order = { 'by': this.provider.phone, 'pincode': this.provider.pincode, 'kyash_code': this.kyash_code};
          app.subTitle = '';
          app.subTitleDesc = 'Payment Points';
          app._displayInPanel(el);
        },

        show_success: function(message) {
          this.successMessage = message;
          this.$.successMsg.show();
        },

        show_error: function(message) {
          this.errorMessage = message;
          this.$.errorMsg.open();
        }
      });
    })();
  </script>
</dom-module>
